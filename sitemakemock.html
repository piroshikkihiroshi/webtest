<!DOCTYPE html>
<html lang="ja">
<meta charset="UTF-8">

<head>
	<title>隠れているかも名店検索</title>
	<!-- CSS と JavaScript -->
	<!--CDN-->
	<link rel="stylesheet" href="../lib/bootstrap-3.2.0/css/bootstrap.min.css">
	<script src="../lib/jquery1.11.1/jquery.min.js"></script>
	<script src="../lib/bootstrap-3.2.0/js/bootstrap.min.js"></script>

	<!-- bootstrap 4 -->
	<!-- <link rel="stylesheet" href="//stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<script src="//code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
	<script src="//stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>		 -->

	<!--datatable-->
	<!-- <script src="//cdn.datatables.net/t/bs-3.3.6/jqc-1.12.0,dt-1.10.11/datatables.min.js"></script> -->
	<script src="../lib/dt-1.10.11/datatables.min.js"></script>
	<!-- スマホではみ出るからコメントアウト -->
	<!-- <link rel="stylesheet" href="//cdn.datatables.net/1.10.18/css/dataTables.bootstrap.min.css"> -->
	<!--スマホ用	-->
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">

	<!-- jQuery Sidebar -->
	<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-sidebar/3.1.0/jquery.sidebar.min.js"></script>

	<!-- dragula -->
	<script src='https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.3/dragula.min.js'></script>

</head>

<style>
	.loading {
		background: url(../img/ajax-loader.gif) no-repeat;
		background-color: none;
		width: 32px;
		height: 32px;
		margin: 0 auto 0 auto;
	}

	.store {
		background: url(../img/store.png) no-repeat;
	}

	.favorite {
		background: url(../img/favorite.png) no-repeat;
	}

	.time {
		background: url(../img/time.png) no-repeat;
	}

	.walk {
		background: url(../img/walk.png) no-repeat;
	}

	.kuthikomi {
		background: url(../img/kuthikomi.png) no-repeat;
	}

	.copy {
		background: url(../img/copy.png) no-repeat;
	}

	.map {
		background: url(../img/map.png) no-repeat;
	}

	/* .description{
		background: url(../img/description.png) no-repeat;
	} */

	.store,
	.favorite,
	.time,
	.walk,
	.kuthikomi,
	.copy,
	.map {
		background-size: 16px;
		background-position: center;
	}

	.py-5 {
		padding-bottom: 5rem !important;
	}

	.py-5 {
		padding-top: 5rem !important;
	}

	.sorting_asc {
		background-color: #C2FFE6;
	}

	.sorting_desc {
		background-color: #FFC7C7;
	}



/* Jquery sidebar */
	.sidebar{
		position: fixed;
		color: #2c2b2b; /* 好みに応じて調節してください */
	}

    .sidebar.left {
      top: 0;
      left: 0;
      bottom: 0;
      width: 270px; /*この値は調節してください。*/
      background: #f0f0f0; /*背景色も好みに応じにて調節してください。*/
	  z-index: 1;
    }

    .sidebar.right {
      top: 0;
      right: 0;
      bottom: 0;
      width: 270px;
      background: #f0f0f0;
	  z-index: 1;
    }

    .sidebar.top {
      left: 0;
      right: 0;
      top: 0;
      height: 270px;
      background: #f0f0f0;
	  z-index: 1;
    }

    .sidebar.bottom {
      left: 0;
      right: 0;
      bottom: 0;
      height: 270px;
      background: #f0f0f0;
	  z-index: 1;
    }
	/* Jquery sidebar end */

</style>

<script>

	//グローバル変数、定数
	const NO_SELECT = "----";
	const SEARCH_URL = '../controller/googlemapfind.php';
	const MAP_SCRIPT_GET = '../api/getMapJs.php';

	var map;
	var marker;
	var infoWindow;
	var marker;
	var myScript
	const fltTokyoLat = 35.680865;
	const fltTokyoLng = 139.767036;
	const intScope = 15; //倍率

	// Jquery sidebar
	// 以下のコードは、公式サイトのデモで使用されていたスクリプトを一部改変したものになります。
	$(document).ready(function () {
		// 向き
		var sides = ["left", "top", "right", "bottom"];

		// サイドバーの初期化
		for (var i = 0; i < sides.length; ++i) {
			var cSide = sides[i];
			$(".sidebar." + cSide).sidebar({side: cSide});
		}

		// ボタンのクリックにより...
		$(".btn[data-action]").on("click", function () {
			var $this = $(this);
			var action = $this.attr("data-action");
			var side = $this.attr("data-side");
			$(".sidebar." + side).trigger("sidebar:" + action);
			return false;
		});

	});


	//init
	$(function () {

		var blRet = false;
		blRet = retDisp();  //getで「retkey」がある場合、retkeyに紐づけされた検索結果を表示する
		if (!blRet) { //getの検索結果がなく、ローカルストレージに前回の検索結果がある場合、表示する
			lastSearch();
		} //if

		//リスト初期化
		var blStroageGet = storageGet();
		//20190730 datatableの言語設定
		// dataTableSetting(); //todo サイドバー入れたら動かなくなった

		//現在地取得
		getPosition();

		//テキストボックスEnter　map検索
		$("#place_search").keypress(function (e) {
			if (e.which == 13) {
				changePin();
			} //if
		}); //function

		//googlemap設定(api keyを秘匿するためscriptを取得しevalで実行しておく)
		getGmapScript();

		//前回の検索条件を取得する
		setSearchConditions();		

		dragula([$('form1'), $('form2')]);

	}); //function

	window.onload = function () {
		// init　サイドバー 開いた状態
		$(".sidebar.right").trigger("sidebar:toggle");
	} //onload	

	// 駅情報は停止
	// window.onload = function () {
	// 	//駅情報作成
	// 	listareasMake();
	// } //onload	

	//api keyを秘匿するためscriptを取得しevalで実行しておく
	// //settimeoutで疑似非同期
	// setTimeout(getGmapScript(), 
	// 1000);

	/**
	* Google Map APIのスクリプトを取得、実行する
	*/
	function getGmapScript() {
		fetch(MAP_SCRIPT_GET).then(res => {
			return res.text();
		}).then(myScript => {
			eval(myScript);
		}).then(() => {
			initMap();
		}).catch((e) => {
			// alert('google map api取得処理でエラーが発生しました');
			console.log('google map api取得処理でエラーが発生しました');
		});		
	} //function


	/**
	* 駅情報のjsonからDOMを作成し表示する
	* @param String retData_i 検索結果のjson
	* @return String 作成DOM
	*/
	function listareasMakeDom(retData_i) {
		var strHtml = '';
		hashStationInfo = retData_i; //グローバル変数に保持
		for (var strKey in hashStationInfo) {
			if (hashStationInfo.hasOwnProperty(strKey)) {
				var objTgtElm = hashStationInfo[strKey];
				strHtml += '<option value="' + objTgtElm.name + '"></option>';
			} //if
		} //for
		return strHtml;
	} //function


	/**
	* listareasのdivを作成する
	* @return boolean
	*/
	function listareasMake() {
		var objListAreaDiv = document.getElementById('listareas');
		$.ajax({
			type: 'POST',
			url: '../api/station.json',
			processData: false, // Ajaxがdataを整形しない指定
			contentType: false, // contentTypeもfalseに指定(Fileをアップロード時は必要)
			async: false, //非同期false
			success: function (retData) {
				objListAreaDiv.innerHTML = listareasMakeDom(retData);
				console.log("success");
				return false;
			}, //function
			error: function (e) {
				console.log("fail");
				return false;
			} //function
		}); //ajax
	} //function


	//20201010
	//検索結果urlをコピーする
	function copyRetUrl() {
		//20201213 検索中判定基準変更
		var strMsg = document.getElementById('retmsg').innerText;
		if(strMsg.indexOf('件以上')>0){
			alert('現在追加検索中なので、もうしばらくお待ちください。');
			return false;
		} //if

		var strRetUrl = '';
		if(window.location.search.indexOf("retkey")>0){ //既にretkeyがある場合そのままのURL
			strRetUrl=location.href;
		}else{ //retkeyがない場合getに＋する
			strRetUrl = location.href + '?retkey=' + localStorage.getItem('retkey');			
		} //if

		copyTextToClipboard(strRetUrl, '検索結果urlをコピーしました。\r\nコピーしたURLでアクセスすると現在の検索結果画面が表示されます。');


	} //function

	/**
	* getで「retkey」がある場合、retkeyに紐づけされた検索結果を表示する
	* @return boolean True:検索結果あり False:検索結果なし
	*/
	function retDisp() {
		var blRet = false;
		var strGetVal = window.location.search;
		if (strGetVal != "" && strGetVal != undefined) { //getparamあり
			var arrGet = strGetVal.replace('?', '').split('=');
			var strKey = arrGet[0];
			var strTgtVal = arrGet[1];
			if (strKey === 'retkey') { //retkeyなら処理を進行
				var strGetJson = '';
				$.ajax({
					type: 'GET',
					url: SEARCH_URL + window.location.search,
					processData: false, // Ajaxがdataを整形しない指定
					contentType: false, // contentTypeもfalseに指定(Fileをアップロード時は必要)
					async: false, //非同期false
					success: function (strGetJson) {
						//20190730 datatable設定
						dataTableSetting();
						$('body').html(retDataMake(strGetJson));
						$("#rettable").DataTable(); //20190730 datatable化
						console.log("success");
						blRet = true;
						return false;
					}, //function
					error: function (e) {
						console.log("fail");
						return false;
					} //function
				}); //ajax

			} //if



		} //if
		return blRet;
	} //function


	/**
	* 前回の検索結果がある場合、前回の検索結果を表示する
	* @return boolean True:検索結果あり False:検索結果なし
	*/
	function lastSearch() {
		var blRet = false;
		var strLastJson = localStorage.getItem('tgtjson');
		if (strLastJson != "" && strLastJson != undefined) { //検索結果あり
			blRet = true;
			//20190730 datatable設定
			dataTableSetting();
			$('body').html(retDataMake(strLastJson));
			$("#rettable").DataTable(); //20190730 datatable化
		} //if
		return blRet;
	} //function

	/**
	* 検索条件をlocalStorageに保存する
	*/
	function saveSearchConditions() {
		localStorage.setItem('inputKeyword', $('#inputKeyword').val());
		localStorage.setItem('radius', $('#radiusselect').val());
		localStorage.setItem('rankselect', $('#rankselect').val());
		localStorage.setItem('ratingstotalselect', $('#ratingstotalselect').val());
		localStorage.setItem('place_search', $('#place_search').val());
	} //function

	/**
	* 前回の検索条件をセットする
	*/
	function setSearchConditions() {
		if(localStorage.getItem('inputKeyword')!==null){
			$('#inputKeyword').val(localStorage.getItem('inputKeyword')); 
		} //if
		if(localStorage.getItem('radius')!==null){
			$('#radius').val(localStorage.getItem('radius')); 
		} //if
		if(localStorage.getItem('rankselect')!==null){
			$('#rankselect').val(localStorage.getItem('rankselect')); 
		} //if	
		if(localStorage.getItem('ratingstotalselect')!==null){
			$('#ratingstotalselect').val(localStorage.getItem('ratingstotalselect')); 
		} //if
		if(localStorage.getItem('place_search')!==null){
			$('#place_search').val(localStorage.getItem('place_search')); 
		} //if

	} //function	


	/**
	* DataTableの設定
	* @return void
	*/
	function dataTableSetting() {
		//20190730 datatableの言語設定
		$.extend($.fn.dataTable.defaults, {
			language: {
				url: "//cdn.datatables.net/plug-ins/9dcbecd42ad/i18n/Japanese.json"
			},
			// "lengthMenu": [[50, 100, -1], [50, 100, "ALL"]],
			"stateSave": true, //表示状態保持
			// 件数切替機能 無効
			lengthChange: false,
			// 検索機能 無効
			searching: false,
			// ページング機能 無効
			paging: false
		});
	} //function

	/**
	* 初期表示画面に戻る際にjsonのlocalStorageをクリアする
	* @return boolean True:検索結果あり False:検索結果なし
	*/
	function backSearchView() {
		localStorage.setItem('tgtjson', '');
		//20201010 uniqueな値を削除
		localStorage.setItem('retkey', '');
		location.href = './';
	} //function


	// 現在地取得処理
	function getPosition() {
		if (navigator.geolocation) {
			// 現在地を取得
			navigator.geolocation.getCurrentPosition(
				// 取得成功した場合
				function (position) {
					$('#tgtlat').val(position.coords.latitude);
					$('#tgtlng').val(position.coords.longitude);

					// //20201009 map対応
					try {
						initMap();
					} catch (error) {
						console.log('google map 想定内エラー(マーカーを現在地に移動させる)');
					} //try
				},
				// 取得失敗した場合
				function (error) {
					switch (error.code) {
						case 1: //PERMISSION_DENIED
							alert("位置情報の利用が許可されていません");
							break;
						case 2: //POSITION_UNAVAILABLE
							alert("現在位置が取得できませんでした");
							break;
						case 3: //TIMEOUT
							alert("タイムアウトになりました");
							break;
						default:
							alert("その他のエラー(エラーコード:" + error.code + ")");
							break;
					} //switch
					return false;
				} //error func
			); //navigator.geolocation.getCurrentPosition
		} else {
			alert("この端末では位置情報が取得できません");
			return false;
		} //if
		return true;
	} //function

	//main機能
	//google map api で店を検索する
	//param intStatus_i 1:現在地検索　2:駅から検索　3:地図(マーカー)から検索
	function searchHiddenStore(intStatus_i) {
		//駅検索をなくしたのでコメントアウト
		// var strStationName = document.getElementById("areaselect").value;

		if (intStatus_i == 1) { //現在地検索
			if ($('#tgtlat').val() == '' || $('#tgtlng').val() == '') {
				alert("位置情報がないため現在地からの検索はできません。");
				return false;
			} //if
		} else if (intStatus_i == 2) { //駅検索
			if (hashStationInfo[strStationName] === undefined) {
				alert("存在しない駅です。");
				return false;
			} //if
			$('#tgtlat').val(hashStationInfo[strStationName].lat);
			$('#tgtlng').val(hashStationInfo[strStationName].lon);
		} else if (intStatus_i == 3) { //地図検索
			$('#tgtlat').val(marker.position.lat());
			$('#tgtlng').val(marker.position.lng());
		} else {
			alert("不正なステータスです");
			return false;
		} //if
		//検索条件保存
		saveSearchConditions();
		var objForm = document.getElementById('mainForm');
		var objFormData = new FormData(objForm); // FormData オブジェクトを作成
		var strHtml = "";
		strHtml += "<div class='alert alert-warning role='alert''>";
		strHtml += "検索中です。しばらくお待ちください。";
		strHtml += "</div>";
		strHtml += ' <div class="loading"></div>';
		//		$('#loadId').html(strHtml); //load中にする
		$('body').html(strHtml); //load中にする
		$.ajax({
			type: 'POST',
			url: SEARCH_URL,
			data: objFormData,
			processData: false, // Ajaxがdataを整形しない指定
			contentType: false, // contentTypeもfalseに指定(Fileをアップロード時は必要)
			success: function (retData) {
				$('body').html(retDataMake(retData));
				//jsondataをlocalStorageへ保存
				localStorage.setItem('tgtjson', retData);
				//20201010 uniqueな値を保持
				var objData = JSON.parse(retData);
				localStorage.setItem('retkey', objData.retkey);

				console.log("success");
				$("#rettable").DataTable(); //20190730 datatable化

				var objData = JSON.parse(retData);
				//※※※※※※※※※※nextステータスがある場合は再度呼ぶ※※※※※※※
				if (objData.next == "1") {
					var objReq = document.createElement('input');
					objReq.type = 'hidden'; //入力フォームが表示されないように
					objReq.name = 'next';
					objReq.value = '1';
					objForm.appendChild(objReq);
					objFormData = new FormData(objForm); // FormData オブジェクトを作成

					$.ajax({
						type: 'POST',
						url: SEARCH_URL,
						data: objFormData,
						processData: false, // Ajaxがdataを整形しない指定
						contentType: false, // contentTypeもfalseに指定(Fileをアップロード時は必要)
						success: function (retData) {
							$('body').html(retDataMake(retData));
							//jsondataをlocalStorageへ保存
							localStorage.setItem('tgtjson', retData);
							//20201010 uniqueな値を保持
							var objData = JSON.parse(retData);
							localStorage.setItem('retkey', objData.retkey);
							console.log("success");
							$("#rettable").DataTable(); //20190730 datatable化
							return false;
						}, //function
						error: function (e) {
							var strHtml = '';
							strHtml += "<div class='alert alert-warning role='alert''>";
							strHtml += "読み込みに失敗しました。管理者にお問い合わせください。<br>";
							strHtml += 'エラーステータス：' + e.status;
							strHtml += "</div>";
							strHtml += '<br><a class="btn btn-primary btn-sm" onclick="backSearchView()">検索ページへ戻る</a>';
							$('body').html(strHtml);
							console.log("fail");
							return false;
						} //function
					}); //ajax
				} //if

				return false;
			}, //function
			error: function (e) {
				var strHtml = '';
				strHtml += "<div class='alert alert-warning role='alert''>";
				strHtml += "読み込みに失敗しました。管理者にお問い合わせください。<br>";
				strHtml += 'エラーステータス：' + e.status;
				strHtml += "</div>";
				strHtml += '<br><a class="btn btn-primary btn-sm" onclick="backSearchView()">検索ページへ戻る</a>';
				$('body').html(strHtml);
				console.log("fail");
				return false;
			} //function
		}); //ajax
	} //function

	/**
	* 検索結果のjsonからDOMを作成し表示する
	* @param String retData_i 検索結果のjson
	* @return String 作成DOM
	*/
	function retDataMake(retData_i) {
		var strHtml = '<div class="container">';
		var objData = null;
		strGMapBase = 'https://www.google.com/maps/search/?api=1&query=Google&query_place_id=';

		strGReviewBase = 'https://search.google.com/local/reviews?placeid=';
		try {
			objData = JSON.parse(retData_i);
		} catch (e) {
			strHtml += "<div class='alert alert-warning role='alert''>";
			strHtml += "jsonのparseに失敗しました。管理者にお問い合わせください。<br>";
			strHtml += e;
			strHtml += "</div></div>";
			strHtml += '<br><a class="btn btn-primary btn-sm" onclick="backSearchView()">検索ページへ戻る</a>';
			return strHtml;
		} //try

		if (objData.status == "OK") {
			strHtml += "<div id='retmsg'  class='alert alert-info role='alert''>";
			strHtml += objData['msg'] + "の隠れた名店候補が見つかりました。</div>";
			strHtml += '<p><a class="btn btn-primary btn-sm" onclick="backSearchView()">検索ページへ戻る</a></p>';
			//20190808 説明をモーダル表示
			strHtml += '<hr>';
			strHtml += '<p>';
			strHtml += '	<a href="#" class="alert-link" style=" text-decoration:none;" data-toggle="modal" data-target="#descModal"><img src="../img/description.png">　Iconについて</img></a>';
			strHtml += '	<a class="btn btn-success btn-sm col-lg-offset-1" onclick="copyRetUrl()">検索結果URLコピー</a>';
			strHtml += '</p>';
			strHtml += '<div class="modal fade" id="descModal" tabindex="-1" role="dialog" aria-labelledby="basicModal"';
			strHtml += '	aria-hidden="true">';
			strHtml += '	<div class="modal-dialog">';
			strHtml += '		<div class="modal-content">';
			strHtml += '			<div class="modal-header">';
			strHtml += '				<h4>Iconについて</h4>';
			strHtml += '			</div>';
			strHtml += '			<div class="modal-body">';
			strHtml += '				<label><img src="../img/store.png">：店名　</img><img src="../img/favorite.png">：評価</img><br><br><img src="../img/kuthikomi.png">：口コミ：※クリックすると口コミの詳細を表示</img><br><br><img src="../img/time.png">：検索地からの徒歩時間(分)</img><br><br><img src="../img/map.png">：Open GoogleMap<br><br><img src="../img/copy.png">：Copy GoogleMap</img><br><br></img><br>※ヘッダを押すことで結果をソート<br><span class="sorting_asc">　　</span>：昇順<br><span class="sorting_desc">　　</span>：降順';
			strHtml += '			</div>';
			strHtml += '			<div class="modal-footer">';
			strHtml += '				<button type="button" class="btn btn-default" data-dismiss="modal">閉じる</button>';
			strHtml += '			</div>';
			strHtml += '		</div>';
			strHtml += '	</div>';
			strHtml += '</div>';
			// strHtml += '<p><img src="../img/store.png">：店名　</img><img src="../img/favorite.png">：評価　</img><br><br><img src="../img/kuthikomi.png">：口コミ：※クリックすると口コミの詳細が表示されます。</img><br><br><img src="../img/time.png">：検索地からの徒歩時間(分)　</img><br><br><img src="../img/map.png">：GoogleMapが開きます　<br><br><img src="../img/copy.png">：GoogleMapのアドレスをコピーします。　</img><br><br></img><br><br>※ヘッダを押すことで結果をソートできます。<br><span class="sorting_asc">　　</span>：昇順<br><span class="sorting_desc">　　</span>：降順</p>';
			strHtml += '<table id="rettable" class="table table-striped table-bordered table-hover table-responsive">';
			strHtml += '	<thead>';
			strHtml += '		<tr>';
			// strHtml += '			</td><td class="store">　</td><td class="favorite">　　</td><td class="kuthikomi">　　</td><td class="time">　　</td><td class="walk">　　</td><td class="map">　　</td><td class="copy">　　</td>';
			strHtml += '			</td><td class="store">　</td><td class="favorite">　　</td><td class="kuthikomi">　　</td><td class="time">　　</td><td class="map">　　</td><td class="copy">　　</td>';
			strHtml += '		</tr>';
			strHtml += '	</thead>';
			strHtml += '	<tbody>';
			glIntCnt = 1;
			for (var objTmp in objData) {
				if (!isNaN(objTmp)) {
					strHtml += '			<tr>';
					// strHtml += '<td>' + glIntCnt + '</td>';
					strHtml += '<td>' + objData[objTmp].name + '</td>';
					strHtml += '<td>' + objData[objTmp].rating + '</td>';
					// strHtml += '<td>' + objData[objTmp].user_ratings_total + '</td>';
					strHtml += '<td><a href=' + strGReviewBase + objData[objTmp].place_id + ' target="_blank">' + objData[objTmp].user_ratings_total + '</a></br></td>';
					var strTmpMin = objData[objTmp].legs.duration.text.replace(" mins", "").replace(" min", "");
					strHtml += '<td>' + strTmpMin + '</td>';
					// strHtml += '<td>' + objData[objTmp].legs.distance.value + 'm</td>';
					//20190801 place_idで遷移させる
					strHtml += '<td><span class="label label-success" onclick="window.open(' + "'" + strGMapBase + objData[objTmp].place_id + "'" + ')">MAP</span></td>';
					strHtml += '<td><span class="label label-info" onclick="copyTextToClipboard(' + "'" + strGMapBase + objData[objTmp].place_id + "'" + ",'GoogleMapのアドレスをコピーしました。'" + ')">COPY</span></td>';
					strHtml += '			</tr>';
					glIntCnt++;
				} //if
			} //for
			strHtml += '	</tbody></table>';
		} else {
			strHtml += "<div class='alert alert-warning role='alert''>";
			strHtml += objData.msg;
			strHtml += "</div>";
		} //if
		strHtml += '<br><a class="btn btn-primary btn-sm" onclick="backSearchView()">検索ページへ戻る</a>';
		strHtml += '</div>';
		return strHtml;

	} //function

	/**
	* localstorageをセットする
	* @return boolean True:セット成功 false:セット失敗
	*/
	function storageSet() {
		localStorage.setItem('inputKeyword', $('#inputKeyword').val());
		localStorage.setItem('radiusselect', $('#radiusselect').val());
		localStorage.setItem('rankselect', $('#rankselect').val());
		localStorage.setItem('ratingstotalselect', $('#ratingstotalselect').val());
		// localStorage.setItem('tgtjson', $('#tgtjson').val());
		return true;
	} //function

	/**
	* localstorageから値を取得できたら初期値をセットする
	* @return boolean True:セット成功 false:セット失敗
	*/
	function storageGet() {
		if (localStorage.getItem('inputKeyword') != "" && localStorage.getItem('inputKeyword') != undefined) {
			$('#inputKeyword').val(localStorage.getItem('inputKeyword'));
		} else {
			$('#inputKeyword').val('');
		} //if

		if (localStorage.getItem('radiusselect') != "" && localStorage.getItem('radiusselect') != undefined) {
			$('#radiusselect').val(localStorage.getItem('radiusselect'));
		} else {
			$('#radiusselect').val('1000');
		} //if

		if (localStorage.getItem('rankselect') != "" && localStorage.getItem('rankselect') != undefined) {
			$('#rankselect').val(localStorage.getItem('rankselect'));
		} else {
			$('#rankselect').val('3.5');
		} //if

		if (localStorage.getItem('ratingstotalselect') != "" && localStorage.getItem('ratingstotalselect') != undefined) {
			$('#ratingstotalselect').val(localStorage.getItem('ratingstotalselect'));
		} else {
			$('#ratingstotalselect').val('1000');
		} //if

		return true;
	} //function

	/**
	 * クリップボードコピー関数
	 * 入力値をクリップボードへコピーする
	 * [引数]   textVal: 入力値
	 * [引数]   strMsg: 成功時msg
	 * [返却値] true: 成功　false: 失敗
	 */
	function copyTextToClipboard(textVal, strMsg) {
		// テキストエリアを用意する
		var copyFrom = document.createElement("textarea");
		// テキストエリアへ値をセット
		copyFrom.textContent = textVal;

		// bodyタグの要素を取得
		var bodyElm = document.getElementsByTagName("body")[0];
		// 子要素にテキストエリアを配置
		bodyElm.appendChild(copyFrom);

		// テキストエリアの値を選択
		copyFrom.select();
		// コピーコマンド発行
		var retVal = document.execCommand('copy');
		// 追加テキストエリアを削除
		bodyElm.removeChild(copyFrom);
		// 処理結果を返却

		alert(strMsg);

		return retVal;
	} //function

	//20201010 google map関係
	/**
	* google mapの初期表示を行う
	*/
	function initMap() {

		//マップ初期表示の位置設定
		var objInitTgt = document.getElementById('googlemaptgt');
		var objInitLatLang = {};
		//現在値が取れる場合は現在値　取れない場合は東京
		if ($('#tgtlat').val() == '' || $('#tgtlng').val() == '') {
			objInitLatLang = { lat: fltTokyoLat, lng: fltTokyoLng };
		} else {
			objInitLatLang = { lat: parseFloat($('#tgtlat').val()), lng: parseFloat($('#tgtlng').val()) };
		} //if

		//マップ表示
		map = new google.maps.Map(objInitTgt, {
			center: objInitLatLang,
			zoom: intScope,
		});

		// マーカーを設置
		marker = new google.maps.Marker({
			position: objInitLatLang,
			map: map
		});

		// クリックイベントを追加
		map.addListener('click', function (e) {
			setMarker(e.latLng, map);
		});

	} //function


	/**
	* 検索した内容でgoogle mapのピンの位置を変更する
	*/
	function changePin() {
		var place = document.getElementById('place_search').value;
		if (place == '') {
			alert('マーカー検索に検索したい場所を入力してください');
			return;
		} //return
		var geocoder = new google.maps.Geocoder();      // geocoderのコンストラクタ

		geocoder.geocode({
			address: place
		}, function (results, status) {
			if (status == google.maps.GeocoderStatus.OK) {

				var bounds = new google.maps.LatLngBounds();

				for (var i in results) {
					if (results[0].geometry) {
						// 緯度経度を取得
						var latlng = results[0].geometry.location;
						// 住所を取得
						var address = results[0].formatted_address;
						// 検索結果地が含まれるように範囲を拡大
						bounds.extend(latlng);
						// マーカーのセット
						setMarker(latlng, map);
						// マーカーへの吹き出しの追加
						setInfoW(place, latlng, address);
						// マーカーにクリックイベントを追加
						markerEvent();
					} //if
				} //for
			} else if (status == google.maps.GeocoderStatus.ZERO_RESULTS) {
				alert(place + "は見つかりませんでした。");
			} else {
				console.log(status);
				alert("エラー発生" + "\r\n" + status);
			} //if
		}); //geocoder.geocode
	} //function


	// マーカーのセットを実施する
	function setMarker(lat_lng, map) {

		// 座標を表示
		console.log(lat_lng.lat());
		console.log(lat_lng.lng());


		//前のマーカーを削除
		deleteMakers();

		// マーカーを設置
		marker = new google.maps.Marker({
			position: lat_lng,
			map: map
		});

		// 座標の中心をずらす
		// http://syncer.jp/google-maps-javascript-api-matome/map/method/panTo/
		map.panTo(lat_lng);
	} //function


	//マーカーを削除する
	function deleteMakers() {
		if (marker != null) {
			marker.setMap(null);
		}
		marker = null;
	}
	// マーカーへの吹き出しの追加
	function setInfoW(place, latlng, address) {
		infoWindow = new google.maps.InfoWindow({
			content: "<a href='http://www.google.com/search?q=" + place + "' target='_blank'>" + place + "</a><br><br>" + latlng + "<br><br>" + address + "<br><br><a href='http://www.google.com/search?q=" + place + "&tbm=isch' target='_blank'>画像検索 by google</a>"
		});
	}
	// クリックイベント
	function markerEvent() {
		marker.addListener('click', function () {
			infoWindow.open(map, marker);
		});
	}


</script>

<body>
	
	<!-- Jquery sidebar -->

	<div class="sidebar right">
		左サイドバー
		<p><a href="#" class="btn" data-action="toggle" data-side="left">左サイドバーを表示・非表示</a></p>
		<p><a href="#" class="btn" data-action="toggle" data-side="right">右サイドバーを表示・非表示</a></p>
		<p><a href="#" class="btn" data-action="toggle" data-side="bottom">下サイドバーを表示・非表示</a></p>
		<p><a href="#" class="btn" data-action="toggle" data-side="top">上サイドバーを表示・非表示</a></p>
	</div>


	<p><a href="#" class="btn" data-action="toggle" data-side="right">右サイドバーを表示・非表示</a></p>
	<!-- Aタグのclass="btn"は必須です。 -->

	 	
	<!-- Header -->
	<header class="bg-primary py-5" style="background-color:#007bff;">
		<div class="container">
			<div class="row align-items-center">
				<div class="col-lg-12">
					<h1 class="display-4 text-white mt-5 mb-2" style="font-family:-apple-system;">Hidden store？</h1>
					<p class="lead">口コミ数が少なく、点数が高いお店は、「常連しか行かないので口コミは少ないが、高く評価されている隠れた名店」である可能性が高いのでは？
						<br>という理論で検索できるシステムです。<br><br>
						※口コミ数を多くすれば人気店の検索にも使用できます
					</p>
				</div>
			</div>
		</div>
	</header>
	<br>
	<div class="container">

		<form id='mainForm' class="form-horizontal">
			<fieldset>

				<div class="form-group">
					<label for="inputKeyword" class="col-lg-2 control-label">キーワード</label>
					<div class="col-lg-10">
						<input type="text" class="form-control" id="inputKeyword" name="inputKeyword" autocomplete="on"
							list="listeats" placeholder="検索したいキーワードを入力してください">
						<span class="help-block">※スペース区切りで&検索が可能です(例:居酒屋 個室)</span>
					</div>
				</div>

				<div class="form-group">
					<label for="radiusselect" class="col-lg-2 control-label">検索半径(m)</label>
					<div  id='form2' class="col-lg-10">
						<select class="form-control selectpicker" id="radiusselect" name="radiusselect">
							<option>100</option>
							<option>200</option>
							<option>300</option>
							<option>400</option>
							<option>500</option>
							<option>1000</option>
							<option>1500</option>
							<option>2000</option>
							<option>3000</option>
							<option>5000</option>
						</select>
						<span class="help-block">※半径で検索するため、道なりの距離では更に距離がかかります。</span>
					</div>
				</div>

				<div class="form-group">
					<label for="rankselect" class="col-lg-2 control-label">ランキング(☆)</label>
					<div class="col-lg-10">
						<select class="form-control selectpicker" id="rankselect" name="rankselect">
							<option>2.5</option>
							<option>3</option>
							<option>3.5</option>
							<option>3.6</option>
							<option>3.7</option>
							<option>3.8</option>
							<option>3.9</option>
							<option>4</option>
							<option>4.1</option>
							<option>4.2</option>
							<option>4.3</option>
							<option>4.4</option>
							<option>4.5</option>
							<option>4.6</option>
							<option>4.7</option>
							<option>4.8</option>
							<option>4.9</option>
							<option>5</option>
						</select>
						<span class="help-block">選んだランキング以上を検索します</span>
					</div>
				</div>

				<div class="form-group">
					<label for="ratingstotalselect" class="col-lg-2 control-label">口コミ数</label>
					<div class="col-lg-10">
						<select class="form-control selectpicker" id="ratingstotalselect" name="ratingstotalselect">
							<option>10</option>
							<option>50</option>
							<option>100</option>
							<option>200</option>
							<option>300</option>
							<option>400</option>
							<option>500</option>
							<option>1000</option>
						</select>
						<span class="help-block">選んだ口コミ数以下を検索します(少ないほうが隠れた名店かも)</span>
					</div>

				</div>



				<hr>
				<h3>検索</h3>
								
				<div class="form-group">					
					<div class="col-lg-8 col-lg-offset-2">
						
						<button type="button" onclick="searchHiddenStore(1)" class="btn btn-primary">現在地から検索</button>
					</div>
				</div>

				<!-- 二つ用意しないとなぜかマップがエラーになる -->
				<div class="form-group">
					<input type="hidden" id="tgtlat" name="tgtlat" value="">
				</div>
				<div class="form-group">
					<input type="hidden" id="tgtlng" name="tgtlng" value="">
				</div>

				<!-- 駅検索 (停止)-->
				<!-- <div class="form-group">
					<label for="areaselect" class="col-lg-2 control-label">駅</label>

					<div class="col-lg-10">
						<input type="text" class="form-control" id="areaselect" name="areaselect" autocomplete="on"
							list="listareas" placeholder="検索したい駅を入力してください">
						<span class="help-block">※「新」などと入れると予測変換で出てきます(例:新橋、新宿)</span>
					</div>
				</div>

				<div class="form-group">
					<div class="col-lg-8 col-lg-offset-2">
						<button type="button" onclick="searchHiddenStore(2)" class="btn btn-success">駅から検索</button>
					</div>
				</div>
				<br> -->


			</fieldset>
		</form>
		<!-- 2020005 マップ検索追加 -->
		<!-- <button type="button" onclick="changePin()" class="btn btn-default">test</button> -->

		<label for="place_search" class="col-lg-offset-1 col-lg-1 control-label">マーカー検索</label>
		<div class="col-lg-10">
			
			<div class="input-group">
				<input type="text" class="form-control" id="place_search" name="place_search" autocomplete="on"
					placeholder="地図検索したいキーワードを入力してください">
				<span class="input-group-btn">
					<button type="button" onclick="changePin()" class="btn btn-default">地図移動</button>
				</span>
			</div>
			<span class="help-block">マーカーを置いた場所から検索できます。
				<br>マーカーの位置は「地図移動」(例:東京駅)か、クリック(タップ)で設置できます。</span>
			<div class="col-lg-8" style="padding-bottom: 10px; margin-left: -25px;">
				<button type="button" onclick="searchHiddenStore(3)" class="btn btn-info">マーカーで検索</button>
			</div>

			<div id="googlemaptgt" class="col-lg-10" style=" height:400px;">
				<div class=" loading"></div>
			</div>

			<!-- 2020005 マップ検索追加 end -->

		</div>


	</div>
</body>
<footer>

	<!-- 駅リスト(動的作成) -->
	<datalist id="listareas">

	</datalist>

	<!-- 食べ物リスト -->
	<datalist id="listeats">
		<option value="居酒屋"></option>
		<option value="懐石料理"></option>
		<option value="会席料理"></option>
		<option value="割烹"></option>
		<option value="小料理"></option>
		<option value="すき焼き"></option>
		<option value="しゃぶしゃぶ"></option>
		<option value="沖縄料理"></option>
		<option value="郷土料理"></option>
		<option value="ほうとう"></option>
		<option value="きりたんぽ鍋"></option>
		<option value="釜めし"></option>
		<option value="京料理"></option>
		<option value="おばんざい"></option>
		<option value="精進料理"></option>
		<option value="料亭"></option>
		<option value="寿司"></option>
		<option value="回転寿司"></option>
		<option value="海鮮丼"></option>
		<option value="刺身・海鮮料理"></option>
		<option value="かに料理"></option>
		<option value="ふぐ料理・てっちり"></option>
		<option value="すっぽん料理"></option>
		<option value="うなぎ"></option>
		<option value="どじょう料理"></option>
		<option value="はも料理"></option>
		<option value="シーフード料理"></option>
		<option value="牡蠣料理（かき料理）"></option>
		<option value="オイスターバー"></option>
		<option value="鯨料理"></option>
		<option value="あなご料理"></option>
		<option value="すし・魚料理 その他"></option>
		<option value="鍋料理"></option>
		<option value="ちゃんこ鍋"></option>
		<option value="水炊き"></option>
		<option value="もつ鍋"></option>
		<option value="火鍋"></option>
		<option value="鍋 その他"></option>
		<option value="焼肉"></option>
		<option value="サムギョプサル"></option>
		<option value="ホルモン"></option>
		<option value="ジンギスカン"></option>
		<option value="牛タン"></option>
		<option value="串揚げ"></option>
		<option value="焼き鳥"></option>
		<option value="鳥料理"></option>
		<option value="炭火焼き・炉端焼き"></option>
		<option value="鉄板焼き"></option>
		<option value="ステーキ"></option>
		<option value="ハンバーグ"></option>
		<option value="串焼き"></option>
		<option value="豚肉料理"></option>
		<option value="馬肉料理"></option>
		<option value="串カツ "></option>
		<option value="もつ焼き"></option>
		<option value="鴨料理"></option>
		<option value="焼き鳥・肉料理・串料理 その他"></option>
		<option value="定食・食事処"></option>
		<option value="家庭料理"></option>
		<option value="おでん"></option>
		<option value="天ぷら"></option>
		<option value="とんかつ"></option>
		<option value="丼物"></option>
		<option value="親子丼"></option>
		<option value="牛丼"></option>
		<option value="天丼"></option>
		<option value="かつ丼"></option>
		<option value="豆腐料理"></option>
		<option value="湯豆腐"></option>
		<option value="湯葉料理"></option>
		<option value="弁当屋"></option>
		<option value="和食 その他"></option>
		<option value="お好み焼き"></option>
		<option value="広島風お好み焼き"></option>
		<option value="もんじゃ焼き"></option>
		<option value="たこ焼き"></option>
		<option value="明石焼き"></option>
		<option value="焼きそば"></option>
		<option value="お好み焼き・粉物 その他"></option>
		<option value="そば"></option>
		<option value="うどん"></option>
		<option value="讃岐うどん"></option>
		<option value="カレーうどん"></option>
		<option value="ちゃんぽん"></option>
		<option value="沖縄そば"></option>
		<option value="冷麺"></option>
		<option value="ラーメン"></option>
		<option value="つけ麺"></option>
		<option value="担々麺"></option>
		<option value="刀削麺"></option>
		<option value="ラーメン・麺料理 その他"></option>
		<option value="広東料理"></option>
		<option value="北京料理"></option>
		<option value="四川料理"></option>
		<option value="上海料理"></option>
		<option value="台湾料理"></option>
		<option value="香港料理"></option>
		<option value="中華料理"></option>
		<option value="餃子"></option>
		<option value="飲茶・点心"></option>
		<option value="チャーハン"></option>
		<option value="中華 その他"></option>
		<option value="フレンチ"></option>
		<option value="イタリアン"></option>
		<option value="パスタ"></option>
		<option value="ピザ"></option>
		<option value="ビストロ"></option>
		<option value="バイキング"></option>
		<option value="ビュッフェ"></option>
		<option value="洋食屋"></option>
		<option value="オムレツ"></option>
		<option value="オムライス"></option>
		<option value="スープ"></option>
		<option value="ハヤシライス"></option>
		<option value="シチュー"></option>
		<option value="チーズフォンデュ"></option>
		<option value="洋食"></option>
		<option value="スペイン料理"></option>
		<option value="ドイツ料理"></option>
		<option value="ロシア料理"></option>
		<option value="地中海料理"></option>
		<option value="欧風料理"></option>
		<option value="カリフォルニア料理"></option>
		<option value="アメリカ料理"></option>
		<option value="ケイジャン料理"></option>
		<option value="パシフィックリム"></option>
		<option value="ハワイアン料理"></option>
		<option value="欧米・各国料理 その他"></option>
		<option value="インドカレー"></option>
		<option value="タイカレー"></option>
		<option value="スープカレー"></option>
		<option value="カレーライス"></option>
		<option value="カレー その他"></option>
		<option value="韓国料理"></option>
		<option value="タイ料理"></option>
		<option value="インドネシア料理"></option>
		<option value="ベトナム料理"></option>
		<option value="インド料理"></option>
		<option value="ネパール料理"></option>
		<option value="トルコ料理"></option>
		<option value="アフリカ料理"></option>
		<option value="メキシコ料理"></option>
		<option value="ブラジル料理"></option>
		<option value="南米料理"></option>
		<option value="モンゴル料理"></option>
		<option value="中近東料理"></option>
		<option value="アジア・エスニック料理 その他"></option>
		<option value="創作和食"></option>
		<option value="創作料理"></option>
		<option value="薬膳料理"></option>
		<option value="オーガニック料理"></option>
		<option value="無国籍料理"></option>
		<option value="野菜料理"></option>
		<option value="ダイニングバー"></option>
		<option value="レストランバー"></option>
		<option value="ビアレストラン"></option>
		<option value="ビアホール"></option>
		<option value="バー"></option>
		<option value="ショットバー"></option>
		<option value="アイリッシュパブ"></option>
		<option value="ワインバー"></option>
		<option value="焼酎バー"></option>
		<option value="立ち飲み"></option>
		<option value="ダーツバー・ゴルフバー"></option>
		<option value="パブ・スナック"></option>
		<option value="クラブ・ラウンジ"></option>
		<option value="スペインバル・イタリアンバール"></option>
		<option value="日本酒"></option>
		<option value="焼酎"></option>
		<option value="泡盛"></option>
		<option value="ビール"></option>
		<option value="紹興酒・中国酒"></option>
		<option value="マッコリ"></option>
		<option value="ワイン"></option>
		<option value="カクテル"></option>
		<option value="ウイスキー"></option>
		<option value="ブランデー"></option>
		<option value="スピリッツ"></option>
		<option value="お酒 その他"></option>
		<option value="カフェ"></option>
		<option value="電源があるカフェ"></option>
		<option value="喫茶店・軽食"></option>
		<option value="クレープ"></option>
		<option value="パフェ"></option>
		<option value="甘味処"></option>
		<option value="フルーツパーラー"></option>
		<option value="ケーキ屋・スイーツ"></option>
		<option value="アイスクリーム"></option>
		<option value="パン屋・サンドイッチ"></option>
		<option value="ハンバーガー"></option>
		<option value="コーヒー"></option>
		<option value="紅茶"></option>
		<option value="日本茶"></option>
		<option value="中国茶"></option>
		<option value="ハーブティ"></option>
		<option value="ジュース"></option>
		<option value="カフェ・スイーツ その他"></option>
		<option value="パーティールーム・スペース"></option>
		<option value="バンケットルーム"></option>
		<option value="宴会場"></option>
		<option value="カラオケボックス"></option>
		<option value="漫画喫茶"></option>
		<option value="インターネットカフェ"></option>
		<option value="テーマパークレストラン"></option>
		<option value="アミューズメント"></option>
		<option value="ライブハウス・クラブ"></option>
		<option value="クルージング"></option>
		<option value="屋形船"></option>
		<option value="ファミリーレストラン"></option>
		<option value="ファーストカジュアル"></option>
		<option value="ファーストフード"></option>
		<option value="イノベーティブ・フュージョン"></option>
		<option value="その他の料理"></option>
	</datalist>
</footer>


</html>